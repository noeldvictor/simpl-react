<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/decorators/simpl.js | Simpl-react API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://gitlab.com/lldev-team/simpl-react.git">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-finalCreateStoreFactory">finalCreateStoreFactory</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-CONNECTION_STATUS">CONNECTION_STATUS</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">actions</div><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-connectedScope">connectedScope</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-disconnectedScope">disconnectedScope</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-getCurrentRunUserInfo">getCurrentRunUserInfo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-getDataTree">getDataTree</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-getRunUserScenarios">getRunUserScenarios</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-getRunUsers">getRunUsers</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-popError">popError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-setConnectionStatus">setConnectionStatus</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-updateScope">updateScope</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-ReduxAction">ReduxAction</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">components</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/RPCCaller.react.js~RPCCaller.html">RPCCaller</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/TopicPublisher.react.js~TopicPublisher.html">TopicPublisher</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/TopicSubscriber.react.js~TopicSubscriber.html">TopicSubscriber</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-ReactElement">ReactElement</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">decorators</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-simpl">simpl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-wamp">wamp</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">decorators/pubsub</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-publishes">publishes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-subscribes">subscribes</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">decorators/rpc</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-calls">calls</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-registers">registers</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">reducers</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-simplReducers">simplReducers</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">test</div><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-store">store</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/decorators/simpl.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import React from &apos;react&apos;;
import PropTypes from &apos;prop-types&apos;;

import { connect } from &apos;react-redux&apos;;

import _ from &apos;lodash&apos;;

import AutobahnReact from &apos;../autobahn&apos;;

import {
  addChild, connectedScope, disconnectedScope, getDataTree, getRunUsers,
  removeChild, updateScope, getCurrentRunPhase, getPhases, getRoles, getCurrentRunUserInfo,
  // eslint-disable-next-line comma-dangle
  getRunUserScenarios, showGenericError, setConnectionStatus
} from &apos;../actions/simpl&apos;;
import { CONNECTION_STATUS } from &apos;../constants&apos;;

import { subscribes } from &apos;./pubsub/subscribes&apos;;
import { wampOptionsWithDefaults, wampSetup } from &apos;./utils&apos;;


/**
 * Decorator to wrap your main app
 * @example
 * export default simpl({
 *   authid: 123,
 *   password: &apos;password&apos;,
 *   url: &apos;ws://example.com/ws&apos;,
 *   progressComponent: MyProgressComponent,
 *   topics: () =&gt; [&apos;topic1&apos;, &apos;topic2&apos;],
 *   root_topic: &apos;org.example.namespace&apos;,
 *   prefixes: {
 *     special: &apos;org.example.namespace.special.shortcut&apos;
 *   }
 * })(MyComponent);

 * @function
 * @memberof Simpl.decorators
 * @param {Object} options - An object of options.
 * @param {string} options.authid - The user id for authenticating on the WAMP
 * Router. This will the user&apos;s id on Simpl-Games-Api
 * @param {string} options.password - The password for authenticating on the
 * WAMP Router.
 * @param {string} options.url - The URL of the WAMP router.
 * @param {function} [options.progressComponent] - A customized Component to
 * show the App&apos;s connection state. The component will receive a
 * `connectionStatus` prop which can have one of the following values:
 * * `connecting`: The initial value. The app is not connected to the WAMP Router, yet.
 * * `connected`: The app is connected and authenticated, but it still needs to download data.
 * * `loaded`: The app has downloaded all the relevant data.
 * * `offline`:  The connection was dropped.
 * @param {function} options.topics - A function returning a list of topics to
 * subscribe to.
 * @param {string} options.root_topic - The root topic for your model. This will
 * be used for the `&apos;model&apos;` prefix.
 * @param {Object} [options.prefixes] - An object mapping names to topic
 * prefixes, to be used as shortcuts.
 */
export function simpl(options) {
  return (Component) =&gt; {
    const optionsWithDefaults = wampOptionsWithDefaults(options);
    if (_.isFunction(options.topics)) {
      optionsWithDefaults.topics = options.topics();
    }

    const mapStateToProps = (state) =&gt; ({
      connectionStatus: state.simpl.connectionStatus,
      errors: state.errors,
      progressComponent: optionsWithDefaults.progressComponent,
    });

    const mapDispatchToProps = (dispatch) =&gt; {
      return ({
        setConnectionStatus(status) {
          dispatch(setConnectionStatus(status));
        },
        onReady() {
          if (optionsWithDefaults.topics) {
            const authid = parseInt(options.authid, 10);
            optionsWithDefaults.topics.forEach((topic) =&gt; {
              dispatch(connectedScope(topic));
              dispatch(
                getRunUsers(topic)
              ).then((action) =&gt; {
                if (action.error) {
                  throw new Error(`${action.payload.error}: ${action.payload.args.join(&apos;; &apos;)}`);
                }
                const runUsers = action.payload;
                for (let i = 0; i &lt; runUsers.length; i++) {
                  const ru = runUsers[i];
                  if (ru.data.user === authid) {  // only load current user&apos;s scenarios
                    dispatch(getRunUserScenarios(`model:model.runuser.${ru.data.id}`));
                    break;
                  }
                }
              }).then(() =&gt; {
                dispatch(getCurrentRunUserInfo(authid));
              });
              dispatch(getCurrentRunPhase(topic));
              dispatch(getDataTree(topic));
            });
          }
          dispatch(getPhases(&apos;model:model.game&apos;));
          dispatch(getRoles(&apos;model:model.game&apos;));
          return Promise.resolve();
        },
        onLeave() {
          if (optionsWithDefaults.topics) {
            optionsWithDefaults.topics.forEach((topic) =&gt; {
              dispatch(disconnectedScope(topic));
            });
          }
          return Promise.resolve();
        },
        onReceived(args, kwargs, event) {
          if (kwargs.error) {
              dispatch(showGenericError(args, kwargs));
          } else {
            const [pk, resourceName, data] = args;
            const resolvedTopics = optionsWithDefaults.topics.map(
              (topic) =&gt; AutobahnReact.Connection.currentConnection.session.resolve(topic)
            );
            resolvedTopics.forEach((topic) =&gt; {
              const actions = {
                [`${topic}.add_child`]: addChild,
                [`${topic}.remove_child`]: removeChild,
                [`${topic}.update_child`]: updateScope,
              };
              if (actions[event.topic]) {
                dispatch(actions[event.topic]({ resource_name: resourceName, data, pk }));
              }
            });
          }
        },
      });
    };


    class AppContainer extends React.Component {

      shouldComponentUpdate(nextProps, nextState) {
        if (this.props.connectionStatus === CONNECTION_STATUS.LOADED) {
          return false;
        }
        return this.props !== nextProps || this.state !== nextState;
      }
      render() {
        return &lt;Component {...this.props} {...this.state} /&gt;;
      }
    }

    AppContainer.propTypes = {
      connectionStatus: PropTypes.string.isRequired,
    };


    const appTopics = optionsWithDefaults.topics.reduce(
      (memo, topic) =&gt; memo.concat([
        `${topic}.add_child`,
        `${topic}.update_child`,
        `${topic}.remove_child`,
      ])
    , [
      `model:error.${options.authid}`,
    ]);
    const SubscribedAppContainer = subscribes(appTopics)(AppContainer);

    // eslint-disable-next-line react/no-multi-comp
    class Simpl extends React.Component {
      componentWillMount() {
        wampSetup(this, optionsWithDefaults);
        window.addEventListener(&apos;beforeunload&apos;, this.props.onLeave);
      }
      componentWillUnmount() {
        window.removeEventListener(&apos;beforeunload&apos;, this.props.onLeave);
      }
      render() {
        if (this.props.connectionStatus !== CONNECTION_STATUS.LOADED) {
          return (
            &lt;div className={`simpl simpl-${this.props.connectionStatus}`}&gt;
              &lt;this.props.progressComponent {...this.props} {...this.state} /&gt;
            &lt;/div&gt;
            );
        }
        return (
          &lt;div className={`simpl simpl-${this.props.connectionStatus}`}&gt;
            &lt;SubscribedAppContainer {...this.props} {...this.state} /&gt;
          &lt;/div&gt;
        );
      }
    }

    Simpl.propTypes = {
      connectionStatus: PropTypes.string.isRequired,
      onLeave: PropTypes.func,
      onReady: PropTypes.func.isRequired,
      progressComponent: PropTypes.func.isRequired,
      setConnectionStatus: PropTypes.func.isRequired,
    };

    const SimplContainer = connect(mapStateToProps, mapDispatchToProps)(Simpl);

    return SimplContainer;
  };
}

/**
 * @namespace simpl
 * @memberof Simpl.decorators
 */
export default simpl;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
