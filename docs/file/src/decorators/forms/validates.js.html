<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">src/decorators/forms/validates.js | Simpl-react API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://gitlab.com/lldev-team/simpl-react.git">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-finalCreateStoreFactory">finalCreateStoreFactory</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-CONNECTION_STATUS">CONNECTION_STATUS</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">actions</div><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-connectedScope">connectedScope</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-disconnectedScope">disconnectedScope</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-getDataTree">getDataTree</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-getRunUserInfo">getRunUserInfo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-getRunUserScenarios">getRunUserScenarios</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-getRunUsers">getRunUsers</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-popError">popError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-setConnectionStatus">setConnectionStatus</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-updateScope">updateScope</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-ReduxAction">ReduxAction</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">components</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/RPCCaller.react.js~RPCCaller.html">RPCCaller</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/TopicPublisher.react.js~TopicPublisher.html">TopicPublisher</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/TopicSubscriber.react.js~TopicSubscriber.html">TopicSubscriber</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-ReactElement">ReactElement</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">components/forms</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-decimalPlaces">decimalPlaces</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-max">max</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-min">min</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-CurrencyInput">CurrencyInput</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DecimalInput">DecimalInput</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-EmailInput">EmailInput</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-FloatInput">FloatInput</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-IntegerInput">IntegerInput</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-NumberInput">NumberInput</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-PasswordInput">PasswordInput</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-TextInput">TextInput</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">decorators</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-simpl">simpl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-wamp">wamp</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">decorators/forms</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-validateField">validateField</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-ValidationOptions">ValidationOptions</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">decorators/pubsub</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-publishes">publishes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-subscribes">subscribes</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">decorators/rpc</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-calls">calls</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-registers">registers</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">reducers</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-simplReducers">simplReducers</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">test</div><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-store">store</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/decorators/forms/validates.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/* eslint &quot;no-underscore-dangle&quot;: &quot;off&quot; */
import React from &apos;react&apos;;
import { connect } from &apos;react-redux&apos;;
import { stopSubmit } from &apos;redux-form&apos;;

import _ from &apos;lodash&apos;;
import validator from &apos;validator&apos;;


const verboseValidator = function verboseValidator(validation, value) {
  if (!value) {
    return null;
  }
  const messages = {
    isEmail: `The specified value &quot;${value}&quot; is not a valid email address.`,
    isNumeric: &apos;The specified value is not an integer.&apos;,
    isDecimal: &apos;The specified value is not a decimal.&apos;,
    isLowercase: &apos;The specified value must be lowercase&apos;,
    isUppercase: &apos;The specified value must be uppercase&apos;,
  };

  return validator[validation](value) ? null : messages[validation] || &apos;Invalid value&apos;;
};

/**
 * Convert a value to a string, if possible. Otherwise returns the unchanged
 * value. `null` and `undefined` are coerced to the empty string.
 *
 * @param      {any}   value   The value to coerced
 * @return     {any}  Either the value converted to a string, or the value itself.
 */
const stringValue = function stringValue(value) {
  if (value === null || value === undefined) return &apos;&apos;;
  return value.toString !== undefined ? value.toString() : value;
};

/**
 * Options to validate a component
 * @typedef {Object} ValidationOptions
 * @property      {Array&lt;string, function&gt;}   errors  An array of validators
 * that may return an error message. For available strings, see the npm [validator](https://www.npmjs.com/package/validator) package
 * @property      {Array&lt;string, function&gt;}   warnings   An array of validators
 * that may return a warning message. For available strings, see the npm [validator](https://www.npmjs.com/package/validator) package
 * @property      {Array&lt;string, function&gt;}   sanitizers  An array of saniters
 * to modify the field&apos;s returned value. For available strings, see the npm [validator](https://www.npmjs.com/package/validator) package
 * @property      {Array&lt;function&gt;}           formatters  An array of saniters
 * to modify the field&apos;s rendered value.
 */

/**
 * Add value validation to a single field.
 * @memberof Simpl.decorators.forms
 * @example
 * import React from &apos;react&apos;;
 *
 * import {validates} from &apos;simpl/lib/decorators/forms/validates&apos;;
 * import {FormControl} from &apos;react-bootstrap&apos;;
 *
 * const noSpam = (value, ownProps) =&gt; {
 *     // validation logic goes here
 *     if (value.endsWith(&apos;@spam.com&apos;)) {
 *         return &quot;that&apos;s spam&quot;
 *     }
 * };
 *
 * const itsNew = (value, ownProps) =&gt; {
 *     if (value === ownProps.previousEmail) {
 *         return &quot;email didn&apos;t change&quot;
 *     }
 * };
 *
 * function EmailField(props) {
 *     // all aestethics goes here
 *     return (
 *         &lt;FormControl
 *             type=&quot;email&quot;
 *             {...props}
 *         /&gt;
 *     )
 * }
 *
 * const ValidatingEmailField = validateField({
 *     errors: [&apos;isEmail&apos;, noSpam],
 *     warnings: [itsNew]
 * )(EmailField);
 *
 * class MyComponent extends React.Component {
 *     render() {
 *         return(
 *             &lt;div&gt;
 *                 &lt;ValidatingEmailField
 *                     previousEmail=&quot;my@email.com&quot;
 *                     errors={[&apos;isRequired&apos;]}
 *                 /&gt;
 *             &lt;/div&gt;
 *         );
 *     }
 * }
 *
 * @param      {ValidationOptions}  options  An object of options
 * @returns    {ReactElement} A React component.
 */
export function validateField({ errors, warnings, sanitizers, formatters }) {
  const errorValidators = errors || [];
  const warningValidators = warnings || [];
  const optionsSanitizers = sanitizers || [];
  const optionsFormatters = formatters || [];

  return (Component) =&gt; {
    const parentProps = Component.defaultProps;

    class ValidatedComponent extends React.Component {
      constructor(props, context) {
        super(props, context);

        let formattedValue = &apos;&apos;;
        if (![undefined, null, &apos;&apos;].includes(this.props.initialValue)) {
          formattedValue = this.format(this.props.initialValue, this.mergedProps(this.props));
        }
        this.state = {
          messages: this.props.messages || [],
          validationState: null,
          value: formattedValue,
          hasReduxForm: context._reduxForm !== undefined,
          name: this.props.name || this.props.input.name,
        };
        this.onChange = this.onChange.bind(this);
        this.onBlur = this.onBlur.bind(this);
        this.onFocus = this.onFocus.bind(this);
      }

      componentWillReceiveProps(props) {
        // add value and errors/warnings coming from redux-form

        if (_.isEqual(this.props, props)) {
          return;
        }

        const newState = {
          validationState: null,
          messages: [],
        };

        if (props.meta) {
          if (props.meta.error) {
            newState.validationState = &apos;error&apos;;
            newState.messages.push(props.meta.error);
          } else if (props.meta.warning) {
            newState.validationState = &apos;warning&apos;;
            newState.messages.push(props.meta.warning);
          }
        }

        this.setState(newState);
      }

      onChange(e) {
        this.setState({
          value: e.target.value,
        });

        if (this.state.hasReduxForm) {
        // Update the redux-form state is the field is decorated with `reduxForm&apos;=
          this.context._reduxForm.dispatch(
            this.context._reduxForm.change(this.state.name, e.target.value)
          );
        }

        if (this.props.onChange) {
          this.props.onChange(e);
        }
      }

      onFocus(e) {
        this.setState({
          validationState: null,
          messages: [],
        });

        if (this.props.focus) {
          this.props.focus(e);
        }
      }

      onBlur(e) {
        if (this.props.readOnly === true) {
          if (this.props.blur) {
            this.props.blur(e);
          }
          return;
        }

        const originalValue = e.target.value;

        const { validationState, allErrors, allWarnings } = this.validate(originalValue);

        const messages = [...allErrors, ...allWarnings];

        const sanitizedValue = this.sanitize(originalValue, this.props);
        const formattedValue = this.format(originalValue, this.mergedProps(this.props));

        // If part of a redux form and there are errors, dispatch actions to
        // mark the form as invalid. Warnings will still allow the form to be
        // submitted.
        if (this.state.hasReduxForm) {
          const formName = this.context._reduxForm.form;
          const reduxFormErrors = { ...this.props.form[formName].submitErrors };
          if (sanitizedValue === null || allErrors.length &gt; 0) {
            reduxFormErrors[this.state.name] = allErrors.join(&apos;, &apos;);
          } else {
            delete reduxFormErrors[this.state.name];
          }
          this.props.stopSubmit(formName, reduxFormErrors);
          this.context._reduxForm.dispatch(
            this.context._reduxForm.blur(this.state.name, e.target.value)
          );
        }

        if (formattedValue !== null) {
          this.setState({
            value: formattedValue,
            validationState,
            messages,
          });
        }

        // the entered value is invalid
        if (sanitizedValue === null) {
          return;
        }

        if (this.props.blur) {
          const sanitizedTarget = Object.assign({}, e.target, { value: sanitizedValue });
          const sanitizedEvent = Object.assign({}, e, { target: sanitizedTarget });
          this.props.blur(sanitizedEvent, formattedValue);
        }
      }

      validate(originalValue) {
        const allErrors = this.mapValidators(
          [...this.props.errors, ...errorValidators], originalValue, this.props
        );
        const allWarnings = this.mapValidators(
          [...this.props.warnings, ...warningValidators], originalValue, this.props
        );

        if (originalValue === &apos;&apos; &amp;&amp; this.props.required === true) {
          allErrors.push(&apos;This field is required.&apos;);
        }

        let validationState = &apos;success&apos;;
        if (allErrors.length) {
          validationState = &apos;error&apos;;
        } else if (allWarnings.length) {
          validationState = &apos;warning&apos;;
        }

        return {
          validationState,
          allErrors,
          allWarnings,
        };
      }

      mergedProps(props) {
        return Object.assign({}, parentProps, props);
      }

      mapValidators(validators, value, props) {
        return validators.map((validation) =&gt; {
          if (_.isFunction(validation)) {
            return validation(value, props);
          } else if (_.isString(validation)) {
            return verboseValidator(
              validation,
              stringValue(value)
            );
          }
          return null;
        }).filter((result) =&gt; result !== null);
      }

      sanitize(value, props) {
        const allSanitizers = [...props.sanitizers, ...optionsSanitizers];

        // `redux-form` commpatibility
        if (props.normalize) {
          allSanitizers.push(props.normalize);
        }

        const sanitizedValue = allSanitizers.reduce((previousValue, sanitizer) =&gt; {
          let sanitizerFunc = sanitizer;
          if (_.isString(sanitizer)) {
            sanitizerFunc = validator[sanitizer];
          }

          const sanitized = sanitizerFunc(stringValue(previousValue));
          if (props.input.type === &apos;number&apos; &amp;&amp; isNaN(sanitized)) {
            return null;
          }
          return sanitized !== null ? sanitized : previousValue;
        }, value);
        return sanitizedValue;
      }

      format(value, props) {
        const allFormatters = [...props.formatters, ...optionsFormatters];
        const formattedValue = allFormatters.reduce(
          (previousValue, formatter) =&gt; formatter(previousValue, props) || previousValue
        , value);
        return formattedValue;
      }

      render() {
        return (
          &lt;span&gt;
            &lt;Component
              {...this.state}
              onChange={this.onChange}
              onBlur={this.onBlur}
              onFocus={this.onFocus}
              type={this.props.type}
              name={this.state.name}
              id={this.props.id}
              required={this.props.required}
              readOnly={this.props.readOnly}
            /&gt;
          &lt;/span&gt;
        );
      }
    }

    ValidatedComponent.defaultProps = {
      errors: [],
      warnings: [],
      sanitizers: [],
      formatters: [],
      required: false,
      readOnly: false,
    };

    ValidatedComponent.contextTypes = {
      _reduxForm: React.PropTypes.object,
    };

    ValidatedComponent.propTypes = {
      name: React.PropTypes.string,
      input: React.PropTypes.object,
      id: React.PropTypes.string,
      required: React.PropTypes.bool,
      readOnly: React.PropTypes.bool,
      initialValue: React.PropTypes.any,
      type: React.PropTypes.string,
      meta: React.PropTypes.object,
      onChange: React.PropTypes.func,
      onBlur: React.PropTypes.func,
      blur: React.PropTypes.func,
      onFocus: React.PropTypes.func,
      messages: React.PropTypes.array,
      errors: React.PropTypes.array,
      warnings: React.PropTypes.array,
      sanitizers: React.PropTypes.array,
      formatters: React.PropTypes.arrayOf(React.PropTypes.func),
    };

    const mapStateToProps = (state, ownProps) =&gt; ({
      form: state.form,
    });
    const mapDispatchToProps = {
      stopSubmit,
    };
    return connect(mapStateToProps, mapDispatchToProps)(ValidatedComponent);
  };
}

export default validateField;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
