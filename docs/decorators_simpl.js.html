<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: decorators/simpl.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: decorators/simpl.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import React from 'react';

import { connect } from 'react-redux';
import {
  addChild, connectedScope, disconnectedScope, getDataTree, getRunUsers,
  removeChild, updateScope, getCurrentRunPhase, getPhases, getRoles,
} from '../actions/simpl';

import { subscribes } from './pubsub/subscribes';
import wamp from './wamp';
import _ from 'lodash';


/**
 * @function
 * @memberof Simpl.decorators
 */
export function simpl(Component, options = {}) {
  const optionsWithDefaults = Object.assign({}, options, {});
  if (_.isFunction(options.topics)) {
    optionsWithDefaults.topics = options.topics();
  }

  const mapStateToProps = (state) => ({
    simplLoaded: state.simpl.loaded,
  });

  const mapDispatchToProps = (dispatch) => ({
    onReady() {
      if (optionsWithDefaults.topics) {
        optionsWithDefaults.topics.forEach((topic) => {
          dispatch(connectedScope(topic));
          dispatch(getRunUsers(topic));
          dispatch(getCurrentRunPhase(topic));
          dispatch(getDataTree(topic));
        });
      }
      dispatch(getPhases('model:model.game'));
      dispatch(getRoles('model:model.game'));
      return Promise.resolve();
    },
    onLeave() {
      if (optionsWithDefaults.topics) {
        optionsWithDefaults.topics.forEach((topic) => {
          dispatch(disconnectedScope(topic));
        });
      }
      return Promise.resolve();
    },
  });

  const appMapDispatchToProps = (dispatch, ownProps) => ({
    // eslint-disable-next-line camelcase
    onReceived([pk, resource_name, data], kwargs, event) {
      const resolvedTopics = optionsWithDefaults.topics.map(
        (topic) => ownProps.Autobahn.Connection.currentConnection.session.resolve(topic)
      );
      resolvedTopics.forEach((topic) => {
        const actions = {
          [`${topic}.add_child`]: addChild,
          [`${topic}.remove_child`]: removeChild,
          [`${topic}.update_child`]: updateScope,
        };
        if (actions[event.topic]) {
          dispatch(actions[event.topic]({ resource_name, data, pk }));
        }
      });
    },
  });

  const AppContainer = React.createClass({
    propTypes: {
      simplLoaded: React.PropTypes.bool,
    },
    shouldComponentUpdate(nextProps, nextState) {
      if (this.props.simplLoaded) {
        return false;
      }
      return this.props !== nextProps || this.state !== nextState;
    },
    render() {
      return &lt;Component {...this.props} {...this.state} />;
    },

  });

  const appTopics = optionsWithDefaults.topics.reduce(
    (memo, topic) => memo.concat([
      `${topic}.add_child`,
      `${topic}.update_child`,
      `${topic}.remove_child`,
    ])
  , []);
  const SubscribedAppContainer = connect(
    null, appMapDispatchToProps
  )(subscribes(AppContainer, appTopics));

  const Simpl = React.createClass({
    propTypes: {
      simplLoaded: React.PropTypes.bool,
      onLeave: React.PropTypes.func,
      onReady: React.PropTypes.func.isRequired,
    },
    componentWillMount() {
      this.props.onReady();
      window.addEventListener('beforeunload', this.props.onLeave);
    },
    componentWillUnmount() {
      window.removeEventListener('beforeunload', this.props.onLeave);
    },
    render() {
      if (!this.props.simplLoaded) {
        return (&lt;div>Loading data...&lt;/div>);
      }
      return &lt;SubscribedAppContainer {...this.props} {...this.state} />;
    },
  });

  const SimplContainer = connect(mapStateToProps, mapDispatchToProps)(Simpl);
  const WampContainer = wamp(SimplContainer, optionsWithDefaults);

  return WampContainer;
}

export default simpl;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Simpl.components.RPCCaller.html">Simpl.components.RPCCaller</a></li><li><a href="Simpl.components.TopicSubscriber.html">Simpl.components.TopicSubscriber</a></li></ul><h3>Namespaces</h3><ul><li><a href="Simpl.html">Simpl</a></li><li><a href="Simpl.actions.html">Simpl.actions</a></li><li><a href="Simpl.actions.messages.html">Simpl.actions.messages</a></li><li><a href="Simpl.actions.simpl.html">Simpl.actions.simpl</a></li><li><a href="Simpl.actions.state.html">Simpl.actions.state</a></li><li><a href="Simpl.components.html">Simpl.components</a></li><li><a href="Simpl.decorators.html">Simpl.decorators</a></li><li><a href="Simpl.decorators.pubsub.html">Simpl.decorators.pubsub</a></li><li><a href="Simpl.reducers.html">Simpl.reducers</a></li><li><a href="Simpl.utils.html">Simpl.utils</a></li><li><a href="Simpl.utils.actions.html">Simpl.utils.actions</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.2</a> on Fri Oct 21 2016 15:55:20 GMT-0500 (CDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
